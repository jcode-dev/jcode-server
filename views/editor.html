<!DOCTYPE html>
<html>
<head>
    <title>Social Logins for Single Page Applications</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Editor</title>
    <style type="text/css" media="screen">
        body {
            overflow: hidden;
        }

        #editor22 {
            margin: 0;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
	<nav>
		<div class="nav-wrapper">
			<a href="#" class="brand-logo">エディター　{{displayName}}　さん。</a>
<div id="_id">{{doc._id}}</div>
            <button id="read">読み込み<button><button id="write">書き込み</button>
		</div>
	</nav>
    <div>
        <pre id="editor">{{doc.content}}</pre>
    </div>
    <script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/twilight");
        editor.session.setMode("ace/mode/javascript");
        editor.setAutoScrollEditorIntoView(true);
        editor.setOption("maxLines", 80);
        editor.setOption("minLines", 10);
/*
        var QueryString = {  
            parse: function(text, sep, eq, isDecode) {
                text = text || location.search.substr(1);
                sep = sep || '&';
                eq = eq || '=';
                var decode = (isDecode) ? decodeURIComponent : function(a) { return a; };
                return text.split(sep).reduce(function(obj, v) {
                var pair = v.split(eq);
                obj[pair[0]] = decode(pair[1]);
                return obj;
                }, {});
            },
            stringify: function(value, sep, eq, isEncode) {
                sep = sep || '&';
                eq = eq || '=';
                var encode = (isEncode) ? encodeURIComponent : function(a) { return a; };
                return Object.keys(value).map(function(key) {
                return key + eq + encode(value[key]);
                }).join(sep);
            },
        };
        var qs = QueryString.parse();
        */

        $(function(){

        // 読み込み直し
        $("#read").click(function() {
            var qs = QueryString.parse();
            var uri = "/doc/read?_id="+qs._id;
            fetch(uri)
            .then(function(response){
                return response.text();
            })
            .then(function(text){
                editor.setValue(text, -1);
            });
        });

        $("#write").click(function(){
            var body = editor.getValue();
            var hostUrl = "/editor/update";
            var _id = $("#_id").text();
            $.ajax({
                url: hostUrl,
                type:'POST',
                dataType: 'json',
                data : {_id: _id, content : body },
                timeout:10000,
            }).done(function(data) {
                ;
            }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                alert("書き込みに失敗しました。");
            })
        });

    });

    </script>
    
</body>
</html>
