<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>プログラミング教育研究所</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
	<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

</head>
<body>
	<div id="app">

		<div class="tile is-ancestor">
			<div class="tile is-parent">
				<div class="tile is-child box">

						<article class="message is-primary">
							<div class="content">
								<div class="message-header">
									教室・イベント
								</div>
								<div class="message-body">
									ID： ${event._id}<br />
									名称： ${event.name}<br />
									日付： ${event.startDate}<br />
									時間： ${event.startTime}～${event.endTime}<br />
									場所： ${event.place}<br />
									説明： ${event.description}<br />
								</div>
							</div>
						</article>
						<div class="control">
							<label class="radio">
								joins<br /><input type="radio" name="q4" value="joins" v-model="currentModel" class="radio" v-on:change="changeModel">
							</label>
							<label class="radio">
								users<br /><input type="radio" name="q4" value="users" v-model="currentModel" class="radio" v-on:change="changeModel">
							</label>
							<label class="radio">
								surveys<br /><input type="radio" name="q4" value="surveys" v-model="currentModel" class="radio" v-on:change="changeModel">
							</label>
						</div>

						<template v-if="joins.length">
							申込総数：${joins.length}<br />

							<button click v-on:click.prevent="copy()">コピー</button><br />

							<div class="field is-horizontal">
								<div class="field-label is-normal">
									<label class="label">アクション</label>
								</div>
								<div class="field-body">
									<div class="field is-narrow">
										<select class="select" v-model="action" required>
											<option value="password">パスワード変更</option>
											<option value="status">ステータス変更</option>
										</select>
									</div>
								</div>
							</div>

							<form v-on:submit.prevent="submitAction">
								<div class="field is-horizontal">
									<div class="field-label is-normal">
										<label class="label">パスワード</label>
									</div>
									<div class="field-body">
										<div class="field is-narrow">
											<input v-model="newPassword" class="input" type="text">
										</div>
									</div>
								</div>
								<div class="control">
									<input class="button is-primary" type="submit" value="更新">
								</div>
							</form>

							<input v-model="allCheck" class="checkbox" type="checkbox" v-on:change="changeAllCheck()">すべて

							<table class="table is-striped">
								<tbody>
									<tr>
										<th>番号</th>
										<th>名前</th>
										<th>email</th>
										<th>ステータス</th>
										<th>アクション</th>
									</tr>
									<tr v-for="join in joins">
										<td><input v-model="join.check" class="checkbox" type="checkbox">${join.memberId.number}</td>
										<td><ruby>${join.memberId.fullname}<rt>${join.memberId.furigana}</rt></ruby></td>
										<td>${join.memberId.email}</td>
										<td>${join.status}</td>
										<td>
											${join.memberId.grade}
											${join.memberId.mainrole}
													<button click v-on:click.prevent="leave(join)">取消</button>
										</td>
									</tr>
								</tbody>
							</table>
						</template>

						<template v-if="users.length">
							ユーザー数：${users.length}<br />
							<button click v-on:click.prevent="copy()">名簿用コピー</button><br />

							<div class="field is-horizontal">
								<div class="field-label is-normal">
									<label class="label">アクション</label>
								</div>
								<div class="field-body">
									<div class="field is-narrow">
										<select class="select" v-model="action" required>
											<option value="password">パスワード変更</option>
											<option value="status">ステータス変更</option>
										</select>
									</div>
								</div>
							</div>

							<form v-on:submit.prevent="submitUsers">
								<div class="field is-horizontal">
									<div class="field-label is-normal">
										<label class="label">パスワード</label>
									</div>
									<div class="field-body">
										<div class="field is-narrow">
											<input v-model="newPassword" class="input" type="text">
										</div>
									</div>
								</div>
								<div class="control">
									<input class="button is-primary" type="submit" value="更新">
								</div>
							</form>

							<input v-model="allCheck" class="checkbox" type="checkbox" v-on:change="changeUserCheck()">すべて

							<table class="table is-striped">
								<tbody>
									<tr>
										<th>番号</th>
										<th>名前</th>
										<th>email</th>
										<th>住所</th>
										<th>TEL</th>
										<th>他の保険</th>
										<th>アクション</th>
									</tr>
									<tr v-for="user in users">
										<td><input v-model="user.check" class="checkbox" type="checkbox">${user.number}</td>
										<td><ruby>${user.fullname}<rt>${user.furigana}</rt></ruby></td>
										<td>${user.email}</td>
										<td>${user.zipcode} ${user.address1}<br />${user.address2}</td>
										<td>${user.tel}</td>
										<td>${user.hadInsurance}</td>
										<td>
											<button class="button" v-on:click.prevent="adminSinin(user.email)">編集</button>

										</td>
									</tr>
								</tbody>
							</table>
						</template>

						<template v-if="surveys.length">
							アンケート回答総数：${surveys.length}<br />

							<table class="table is-striped">
								<tbody>
									<tr>
										<th>check</th>
										<th>名前</th>
										<th>役員候補</th>
										<th>プログラミング</th>
										<th>曜日</th>
										<th>回数</th>
										<th>年齢</th>
										<th>メモ</th>
									</tr>
									<tr v-for="survey in surveys">
										<td>
											<input v-model="survey.check" class="checkbox" type="checkbox">
											<template v-if="(survey.memberId && survey.memberId._id)">
												${survey.memberId.number}
											</template>
										</td>
										<td>
											<template v-if="(survey.memberId && survey.memberId._id)">
												<ruby>${survey.memberId.fullname}<rt>${survey.memberId.furigana}</rt></ruby>
											</template>
										</td>
										<td>${ survey.q_exec }</td>
										<td>${ survey.q_program }</td>
										<td>
										
												<label class="checkbox">
			<br /><input type="checkbox" v-model="survey.week_day" class="checkbox">平日
		</label>
		<label class="checkbox">
			<br /><input type="checkbox" v-model="survey.sat_am" class="checkbox">土曜 午前
			<br /><input type="checkbox" v-model="survey.sat_pm" class="checkbox">土曜 午後
		</label>
		<label class="checkbox">
			<br /><input type="checkbox" v-model="survey.sun_am" class="checkbox">日曜 午前
			<br /><input type="checkbox" v-model="survey.sun_pm" class="checkbox">日曜 午後
		</label>

										
										</td>
										<td>${ survey.q_time }</td>
										<td>${ survey.age_class }</td>
										<td width=600>${ survey.memo }</td>
									</tr>
								</tbody>
							</table>
						</template>

				</div>
			</div>
		</div>
	</div>
	
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="/ui/js/restapi.js"></script>
	<script>

const app = new Vue({
	delimiters: ['${', '}'],
	el: '#app',
	data: {
		currentModel:"users",
		signedin: false,
		nexturl: "",
		go_profile: "",
		users: [],
		user: {},
		events: [],
		event:{},
		joins: [],
		surveys: [],
		allCheck: false,
		action: "",
		newPassword:"",
		eventId: "",
	},
	mounted: function() {
		this.nexturl = location.pathname + location.search;
		// Query文字列を見る
		var v = restapi.getUrlVars();
		var id  = v && v.id ? v.id : null;
		if (! id) {
			this.getEvents();
			return;
		}
		this.getEvent(id);
		this.whoami();
		this.eventId = id;
		this.changeModel();
	},
	methods: {
		// 名簿のコピー（エクセルに貼り付ける用）
		copy: function() {
			var str = "";
			var dc = '"';
			var dl = "\t";
			var er = "\n";
			for (let u of this.users) {
				if (u.check) {
					var tel = u.tel.replace(/[━.*‐.*―.*－.*\-.*ー.*\-]/gi,'');
					tel = tel.replace(/^(03|\d{3})(\d{3,4})(\d{4})$/, '$1-$2-$3');
					var s = u.number+dl + u.furigana+dl + u.fullname+dl + u.zipcode+dl + u.address1+dl + (u.address2?u.address2:'')+dl + tel+dl + (!! u.hadInsurance)+dl +  u.email+dl +er;
					str += s;
				}
			}
			console.log("str", str);
			restapi.copyToClipboard(str);
		},
		// サインイン(管理者用)
		adminSinin: function(email, password = "") {
			restapi.post("user/signinadmin", {email:email, password: password}).then((response) => {
				restapi.pushToken(response.data);
				window.open('/ui/class/user.html?id=xx', '_blank');
			});
		},
		// 表示モード切替
		changeModel: function() {
			this.joins = [];
			this.users = [];
			this.surveys = [];
			if (this.currentModel === "joins") {
				this.getJoins(this.eventId);
			} else if (this.currentModel === "users") {
				this.getUsers(this.eventId);
			} else if (this.currentModel === "surveys") {
				this.getSurveys(this.eventId);
			}
		},
		submitAction: function() {
			var pass = this.newPassword;
			for (join of this.joins) {
				if (join.check) {
					
					restapi.post("user/password/"+join.memberId._id, {password: pass}).then((response) => {
						console.log(response);
					})
				}
			}
		},
		changeUserCheck: function(){
			var check = this.allCheck;
			for (join of this.users) {
				join.check = check;
			}
		},
		changeAllCheck: function(){
			var check = this.allCheck;
			for (join of this.joins) {
				join.check = check;
			}
		},
		// ユーザー情報
		whoami: function() {
			console.log("redrawAll", this.nexturl);
			restapi.get("user/whoami/").then((response) => {
				this.user = response.data;
				this.signedin = true;
			}).catch(function(err){
				console.log("whoami:", err);
				this.user = {name: 'ゲスト'};
				this.signedin = false;
			});
		},
		// アンケート一覧
		getSurveys: function(id) {
			restapi.get("staffs01/list/"+id).then((response) => {
				var arr = response.data;
				arr.sort(function(a, b){
					return a.memberId.number -b.memberId.number
				});
				this.surveys = arr;
			});
		},
		// ユーザー覧
		getUsers: function(id) {
			restapi.get("user/").then((response) => {
				this.users = response.data;
			});
		},
		// 参加者一覧
		getJoins: function(id) {
			restapi.get("join/?gid="+id).then((response) => {
				this.joins = response.data;
			});
		},
		// イベント情報
		getEvent: function(id) {
			restapi.get("event/"+id).then((response) => {
				var event = response.data;
				event.startDate = restapi.getDate(event.startDatetime);
				event.startTime = restapi.getTime(event.startDatetime);
				event.endTime = restapi.getTime(event.endDatetime);
				this.event = event;
			});
		},
		// サインアウト
		adminSinout: function() {
			this.signedin = false;
			restapi.popToken();
			this.whoami();
		},
	}
})
/*
use kids2020
db.docs.find({__t:"staffs01"});
db.docs.find({__t:"staffs01"}).snapshot().forEach(
  function(e){
    e.memberId = e.ownerId;
    db.docs.save(e);
  }
)

*/

	</script>

</body>
</html>
